<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title> PPOL670 | Introduction to Data Science for Public Policy   Week 6       Webscraping &amp; APIs</title>
    <meta charset="utf-8" />
    <meta name="author" content="  Prof. Eric Dunford  ◆  Georgetown University  ◆  McCourt School of Public Policy  ◆  eric.dunford@georgetown.edu" />
    <link rel="stylesheet" href="gu-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# <font class = "title-panel"> PPOL670 | Introduction to Data Science for Public Policy </font> <font size=6, face="bold"> Week 6 </font> <br> <br> <font size=100, face="bold"> Webscraping &amp; APIs </font>
### <font class = "title-footer">  Prof. Eric Dunford  ◆  Georgetown University  ◆  McCourt School of Public Policy  ◆  <a href="mailto:eric.dunford@georgetown.edu" class="email">eric.dunford@georgetown.edu</a></font>

---




layout: true

&lt;div class="slide-footer"&gt;&lt;span&gt; 
PPOL670 | Introduction to Data Science for Public Policy

&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;

Week 6 &lt;!-- Week of the Footer Here --&gt;

&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;&amp;emsp;

Webscraping &amp; APIs &lt;!-- Title of the lecture here --&gt;

&lt;/span&gt;&lt;/div&gt; 

---
class: outline

# Outline for Today 

&lt;br&gt;&lt;br&gt;

- **Refresh on Loops and Functions**

- **Webscraping**

- **Using APIs**

---

class: newsection

## Loops &amp; Functions

---

### `for` loop components

(1) the **_`for()` function_** which we use to specify 
  
  a. what object we're drawing from and 
  
  b. what object we are writing to.

&lt;br&gt; 

```{}
            for( i  in  items  )
                 ^        ^
                 |        |___ object we are drawing from
                 |
          obj. we write each item to 
```

---

### `for` loop components

(2) the **_brackets `{}`_**, which houses the code that is going to happen each iteration&lt;/u&gt;. 

&lt;br&gt; 
```{}
        for( i  in  items  ){
          |~~~~~~~~~~~~~~~~|   
          |~~~~~~~~~~~~~~~~|
          |~~~~~~~~~~~~~~~~| code we need perform on each iteration.
          |~~~~~~~~~~~~~~~~|
          |~~~~~~~~~~~~~~~~|
        }
```


---

### Storing output in a _predefined_ data object


```r
letters
```

```
##  [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q"
## [18] "r" "s" "t" "u" "v" "w" "x" "y" "z"
```



```r
# Container with 10 spaces
container &lt;- rep(0,10)
container
```

```
##  [1] 0 0 0 0 0 0 0 0 0 0
```



```r
# Each loop, we store the output of some code.
for(i in 1:10){
  container[i] &lt;- paste0(letters[i],letters[i+1])
}
container
```

```
##  [1] "ab" "bc" "cd" "de" "ef" "fg" "gh" "hi" "ij" "jk"
```


---

### Storing data by binding output


```r
containter2 &lt;- c()
for( i in 1:10){
  
  tmp_data &lt;- data.frame(v1=i,v2=letters[i])
  
  containter2 &lt;- bind_rows(containter2,tmp_data)
  
}
containter2
```

```
##    v1 v2
## 1   1  a
## 2   2  b
## 3   3  c
## 4   4  d
## 5   5  e
## 6   6  f
## 7   7  g
## 8   8  h
## 9   9  i
## 10 10  j
```

---

## Writing Functions

![:space 5]


```r
# Basic Set Up

my_function = function(x,y) # Arguments broken up by commas
{ # Brackets that house the code 
  
  # Some code to execute 
  z = x*y
  
  return(z) # Return a data value
}

my_function(5,6)
```

```
## [1] 30
```

---

## When to Write Functions

![:space 10]
### (1) Using the same code more than once

&lt;br&gt;

### (2) Complicated operation 

&lt;br&gt;

### (3) Vectorization 

---

class: newsection

## So you wanna scrape the web...

---

### What does it mean to "scrape" something off the web?

--

&lt;br&gt;
&lt;br&gt;

- leveraging the structure of a website to **grab it's contents**

- using a programming environment (such as R, Python, Java, etc.) to **systematically extract** that content.

- accomplishing the above in an "unobtrusive" and **legal** way.

---

### Website 

As internet consumers, we interact with the interface (or a **rendered version**) of a [webpage](https://www.bbc.com/news/world-middle-east-36156865). Since websites are just rendered code, every piece of that code can be tapped into.

.pull-left[
&lt;img src = "Figures/rendered-webpage.png" width=400&gt;
]

.pull-right[
&lt;img src = "Figures/html-webpage.png" width=400&gt;
]

---

### The many faces of HTML code

Keep in mind that there is 5 types of coding playing out simultaneously when rendering a website:

--

- **HTML**: generates/creates the actual content of a website
- **XML**: used to transmit data to a webpage from a server
- **PHP**: relays information between a server and the page (think passwords)
- **CSS**: responsible for the design of the website
- **JavaScript**: handles changes and animation.

--

All these different pieces of code work in conjunction (so all will be simultaneously present when viewing a website).

When scraping, we care primarily about **CSS** and **XML**.



---

### The Sturcture of HTML

![:space 5]

HTML code is structured using tags, and information is organized hierarchcially (like a list or an array) from top to bottom. When scraping, the tags that are of most use are:

- **p** – paragraphs
- **a href** – links
- **div** – divisions
- **h** – headings
- **table** – tables

We can examine the HTML of a website by inspecting the content within it.

---

### R Packages

There are many packages that can be effectively used to download content from a website. Here I highlight a few, but new stuff is coming out all the time.

&lt;br&gt;&lt;br&gt;


```r
require(rvest) # existing in the tidyverse 
require(httr) # great for interacting with APIs
require(xml2) # rvest draw from this package
require(RCurl) # older but stable. Behaves well with other packages
require(XML) # older but stable. Behaves well with other packages
require(jsonlite) # for dealing with json output
```


---

class:newsection

## Scraping Content

---

### ABCs of Webscraping 

Let's scrape content off of the following BBC [news story](https://www.bbc.com/news/world-middle-east-36156865).

--

&lt;br&gt;

When scraping data online, keep the following procedure in mind:

- (**A**) identify what information you want
- (**B**) examine the HTML structure and elements
- (**C**) download website
- (**D**) extract element (i.e. it's position)
- (**E**) clean element
- (**F**) store outcome

---

### ABCs of Webscraping 

Let's scrape content off of the following BBC [news story](https://www.bbc.com/news/world-middle-east-36156865).

&lt;br&gt;

Here let's aim to extract three pieces of information from the BBC story:

- **Headline**

- **Date**

- **Story Content**

---

### Download the website

![:space 5]


```r
require(rvest) 

url = "https://www.bbc.com/news/world-us-canada-51545383"
site = read_html(url)
site
```

```
## {xml_document}
## &lt;html lang="en" id="responsive-news"&gt;
## [1] &lt;head prefix="og: http://ogp.me/ns#"&gt;\n&lt;meta http-equiv="Content-Typ ...
## [2] &lt;body id="asset-type-sty" class="device--feature"&gt;\n&lt;!--&lt;![endif]--&gt; ...
```

![:space 5]

Here the entire information located on the website is no retained in a single object. **Why is this useful?**

---

### Extract and clean the desired element

![:space 5]

Let's locate the XML code for the headline.


```r
headline.path = "//*[@id='page']/div[1]/div[2]/div/div[1]/div[1]/h1"
headline = site %&gt;% html_node(.,xpath = headline.path)
headline
```

```
## {xml_node}
## &lt;h1 class="story-body__h1"&gt;
```

![:space 5]

Still jargon ...


---

### Extract and clean the desired element

![:space 5]

We need to clarify what _kind_ of element we are seeking to retrieve (think of this as translating the HTML).


```r
headline = headline %&gt;% html_text(.)
headline
```

```
## [1] "Bloomberg to join Democratic debate amid poll surge"
```

![:space 5]

**Success!**

---

### Extraction takes many forms


```r
site %&gt;% 
  html_node(.,xpath = headline.path) %&gt;% 
  html_name(.)
```

```
## [1] "h1"
```


```r
site %&gt;% 
  html_node(.,xpath = headline.path) %&gt;% 
  html_attrs(.)
```

```
##            class 
## "story-body__h1"
```


```r
site %&gt;% 
  html_node(.,xpath = headline.path) %&gt;% 
  html_structure(.)
```

```
## &lt;h1.story-body__h1&gt;
##   {text}
```

---

### Rinse, wash, and repeat: Date

![:space 5]


```r
# Grab the date using CSS
date.path = "#page &gt; div:nth-child(1) &gt; div.container &gt; div &gt; div.column--primary &gt; div.story-body &gt; div.with-extracted-share-icons &gt; div &gt; div.story-body__mini-info-list-and-share-row &gt; div.mini-info-list-wrap &gt; ul &gt; li &gt; div"

# So long! That's why I prefer XML
date = site %&gt;% 
  html_node(.,css = date.path) %&gt;% 
  html_text(.)

# format date into a usable "R format"
date = as.Date(date,"%d %b %Y")
date
```

```
## [1] "2020-02-18"
```

---

### Rinse, wash, and repeat: Story

![:space 5]

To get **all** of the body text, we really need to think about what it is we are grabbing. Here comprehending the structure of the website can be really useful.


```r
body.path = "//*[@id='page']/div[1]/div[2]/div/div[1]/div[1]/div[2]/p[1]"

site %&gt;% 
  html_node(.,xpath=body.path) %&gt;% 
  html_text(.)
```

```
## [1] "Democratic presidential candidate Michael Bloomberg will take part in a nomination debate for the first time on Wednesday, his campaign confirmed. "
```

This will only give us a piece of the story – **p[1]**

---

### Rinse, wash, and repeat: Story

But we want the _whole_ thing


```r
body.path = "//*[@id='page']/div[1]/div[2]/div/div[1]/div[1]/div[2]/p"

body &lt;- 
  site %&gt;% 
* html_nodes(.,xpath=body.path) %&gt;%
  html_text(.) 
body
```

```
##  [1] "Democratic presidential candidate Michael Bloomberg will take part in a nomination debate for the first time on Wednesday, his campaign confirmed. "                                                                                                                       
##  [2] "In order to take part in the Nevada debate, he had to poll above double digits in four national polls recognised by the Democratic Party. "                                                                                                                                
##  [3] "On Tuesday, a NPR/PBS NewsHour/Marist poll found he had support from 19% of those surveyed. "                                                                                                                                                                              
##  [4] "The ex-New York Mayor is not competing in the first four nomination contests. "                                                                                                                                                                                            
##  [5] "Mr Bloomberg, 78, has instead chosen to enter the race on 3 March, known as Super Tuesday, when 14 states will vote. "                                                                                                                                                     
##  [6] "He came in second place in the NPR/PBS NewsHour/Marist poll. Bernie Sanders came in first with 31% support nationally and Joe Biden was in third place with 15%. "                                                                                                         
##  [7] "\"Mike is looking forward to joining the other Democratic candidates on stage and making the case for why he's the best candidate to defeat Donald Trump and unite the country,\" Mr Bloomberg's campaign manager Kevin Sheekey said in a statement."                      
##  [8] "Billionaire businessman Mr Bloomberg has spent hundreds of millions of dollars on television, radio and digital advertising for his campaign. "                                                                                                                            
##  [9] "According to CNN, he has a campaign operation involving more than 2,000 aides in New York and across the country. "                                                                                                                                                        
## [10] "Mr Bloomberg has been accused by rival candidates Elizabeth Warren and Bernie Sanders of trying to buy the election. He denies the claims and has offered to fund the Democratic effort to beat Republican President Donald Trump even if he does not win the nomination. "
## [11] "During a Democratic dinner in Nevada on Saturday, Mr Sanders said: \"I got news for Mr Bloomberg, and that is the American people are sick and tired of billionaires buying elections.\""                                                                                  
## [12] "During the debate Mr Bloomberg is expected to face tough questions over some of his policies as mayor. "                                                                                                                                                                   
## [13] "He was criticised over his support for the \"stop and frisk\" policy that saw a disproportionate number of black or Latino people questioned and searched by police officers. "                                                                                            
## [14] "He has issued apologies, however Joe Biden has vowed to challenge him on the policy. "                                                                                                                                                                                     
## [15] "Democratic candidate Amy Klobuchar said she thought Mr Bloomberg should be on the debate stage. She told NBC's Meet the Press: \"He can't hide behind the airwaves. He has to answer questions.\""
```

---

### Storage

![:space 5]


```r
output &lt;- 
  tibble(headline,
         date,
*        body = paste0(body,collapse=" "))
output
```

```
## # A tibble: 1 x 3
##   headline                    date       body                              
##   &lt;chr&gt;                       &lt;date&gt;     &lt;chr&gt;                             
## 1 Bloomberg to join Democrat… 2020-02-18 "Democratic presidential candidat…
```


```r
# Number of characters in the variable entry
nchar(output$body) 
```

```
## [1] 2244
```

---

### Sidenote on `html_table`s

![:space 10]

Sometimes data is conveniently organized as **_tables_** in the html code, i.e. there is a table tag in the `&lt;table&gt;`.

For example, let's look at this [Wikipedia post on English Towns and Cities](https://en.wikipedia.org/wiki/List_of_towns_in_England)... should look familiar ;).

Extracting the **_table in the post_** is a breeze thanks to the `html_table()` function.

_Note that there can be many tables on a page, `html_table()` downloads them all and then stores the content as a list._

---

### Sidenote on `html_table`s


```r
url &lt;- 'https://en.wikipedia.org/wiki/List_of_towns_in_England'

d &lt;- read_html(url) %&gt;% 
  html_table(fill = TRUE)

*d[[1]] # Data returned as a list
```

```
##                      Town  Ceremonial county              Status
## 1      Abingdon-on-Thames        Oxfordshire       town council1
## 2              Accrington         Lancashire borough (1878–1974)
## 3                    Acle            Norfolk      market charter
## 4                   Acton     Greater London borough (1921–1965)
## 5               Adlington         Lancashire       town council1
## 6                Alcester       Warwickshire        town council
## 7               Aldeburgh            Suffolk       town council1
## 8               Aldershot          Hampshire borough (1922–1974)
## 9                  Alford       Lincolnshire       town council1
## 10               Alfreton         Derbyshire        town council
## 11                Alnwick     Northumberland       town council1
## 12                Alsager           Cheshire       town council1
## 13                 Alston            Cumbria      market charter
## 14                  Alton          Hampshire       town council1
## 15             Altrincham Greater Manchester borough (1937–1974)
## 16                  Amble     Northumberland       town council1
## 17              Ambleside            Cumbria      market charter
## 18               Amersham    Buckinghamshire        town council
## 19               Amesbury          Wiltshire        town council
## 20               Ampthill       Bedfordshire       town council1
## 21                Andover          Hampshire borough (1835–1974)
## 22 Appleby-in-Westmorland           Cumberia       town council1
## 23                Arlesey       Bedfordshire        town council
## 24                Arundel        West Sussex       town council1
## 25              Ashbourne         Derbyshire       town council1
## 26              Ashburton              Devon       town council1
## 27      Ashby-de-la-Zouch     Leicestershire       town council1
## 28           Ashby Woulds     Leicestershire       town council1
## 29                Ashford               Kent      market charter
## 30              Ashington     Northumberland        town council
## 31      Ashton-under-Lyne Greater Manchester borough (1847–1974)
## 32                 Askern    South Yorkshire        town council
## 33               Aspatria            Cumbria        town council
## 34             Atherstone       Warwickshire        town council
## 35           Attleborough            Norfolk        town council
## 36               Axbridge           Somerset        town council
## 37              Axminster              Devon        town council
## 38              Aylesbury    Buckinghamshire        town council
## 39                Aylsham            Norfolk        town council
```

---

class:newsection

## Building a Scraper

---

### Got the bones? Get the goods

Once you have a blueprint of the HTML structure, you can easily find your way around.

We can **systematically use the information** we know about the HTML structure to grab new information with ease.

This allows us to draw similar information from similarly composed html pages. 
--

### HTML structure changes over time!

Websites are constantly being updated, reformatted, and changed in other ways. This presents a real challenge when scraping, because we need to understand the variability in the structure and adapt our code to it.

---

### Building a "BBC Scraper"

![:space 5]

The aim: 

- wrap the three steps from the example into a convenient function. 

- the function takes in a _url_ as **input**, and

- **outputs** the desired web content. 

---


```r
bbc_scraper &lt;- function(url){
     
  # Download website   
  raw = read_html(url)
  
  # Extract headline
  headline = raw %&gt;% 
    html_nodes(.,xpath="//*[@id='page']/div[1]/div[2]/div/div[1]/div[1]/h1") %&gt;% 
    html_text(.)
  
  # Extract data
  date = raw %&gt;% 
    html_nodes(.,xpath="//*[@id='page']/div[1]/div[2]/div/div[1]/div[1]/div[1]/div/div[1]/div[1]/ul/li/div") %&gt;% 
    html_text(.) %&gt;% as.Date(.,"%d %b %Y")
  
  # Extract Story
  story = raw %&gt;% 
    html_nodes(.,xpath="//*[@id='page']/div[1]/div[2]/div/div[1]/div[1]/div[2]/p") %&gt;% 
    html_text(.) %&gt;% paste0(.,collapse = " ")
  
  # Output as data frame and return
  data.out = data.frame(headline,date,story)
  return(data.out)
}
```


---


![:space 10]

Now all we need is to feed it urls


```r
urls &lt;- c("http://www.bbc.com/news/world-middle-east-36156865",
          "http://www.bbc.com/news/world-middle-east-36162701",
          "http://www.bbc.com/news/world-australia-36166803",
          "http://www.bbc.com/news/world-latin-america-36166632")

output &lt;- c()
for(i in 1:length(urls)){
  draw &lt;- bbc_scraper(urls[i])  
  output &lt;- bind_rows(output,draw)
}

str(output)
```

```
## 'data.frame':	4 obs. of  3 variables:
##  $ headline: chr  "Syria conflict: UN envoy calls on US and Russia to save talks" "Syria conflict: Aleppo in 'catastrophic' state says UN" "Asylum seeker dies in Australia from self-inflicted burns" "Brazilian president's campaign strategist charged"
##  $ date    : Date, format: "2016-04-28" "2016-04-28" ...
##  $ story   : chr  "The UN envoy to Syria has urged the US and Russia to intervene \"at the highest level\" to save struggling peac"| __truncated__ "The UN says the situation in Syria's city of Aleppo is catastrophic, after dozens of people were killed in atta"| __truncated__ "A 23-year-old Iranian asylum seeker who set himself on fire at Australia's detention centre on the island of Na"| __truncated__ "Brazilian prosecutors have filed corruption charges against President Dilma Rousseff's electoral strategist.  J"| __truncated__
```

---

![:space 10]


```r
output$headline 
```

```
## [1] "Syria conflict: UN envoy calls on US and Russia to save talks"
## [2] "Syria conflict: Aleppo in 'catastrophic' state says UN"       
## [3] "Asylum seeker dies in Australia from self-inflicted burns"    
## [4] "Brazilian president's campaign strategist charged"
```


```r
output$date
```

```
## [1] "2016-04-28" "2016-04-28" "2016-04-29" "2016-04-29"
```


```r
output$story
```

```
## [1] "The UN envoy to Syria has urged the US and Russia to intervene \"at the highest level\" to save struggling peace talks. Speaking after briefing the Security Council on the peace process, Staffan de Mistura said a partial truce agreed in February was \"barely alive\". Violence in Syria has intensified in recent days, despite the ceasefire. At least 20 civilians were reportedly killed on Wednesday in government strikes on a hospital and nearby residential building in eastern Aleppo. The dead included children, a dentist and the only paediatrician left in rebel-held areas of the city, civil defence volunteers told AFP news agency. Over the past week, more than 100 civilians have been killed in renewed bombardment by both rebel and government forces in Syria's largest city, according to the UK-based Syrian Observatory for Human Rights monitoring group. The upsurge in violence comes amid reports that the Syrian army, backed by Russian air power, is gearing up for a major offensive in Aleppo. The escalation has threatened to derail the UN-brokered peace talks, which resumed last month. The Western-backed opposition delegation, the High Negotiations Committee (HNC), last week suspended its role to protest against alleged ceasefire violations by the government and a fall in humanitarian aid deliveries to besieged areas. Russia's continuing war Has opportunity for peace been lost? What is left of Syria? Assad's growing confidence Speaking on Wednesday after a third round of talks in Geneva, Mr de Mistura said the fragile \"cessation of hostilities\" \"could collapse any time\". He said that over the past 48 hours an average of one Syrian had been killed every 25 minutes and one wounded every 13 minutes. For the peace talks to succeed, Mr de Mistura said, hostilities would need to be reduced to the levels seen immediately following the February agreement. Calling on the US and Russia to co-operate, he said the legacies of both President Barack Obama and President Vladimir Putin were linked to the success of the peace process in Syria. There will be one or two more rounds of talks before July, Mr de Mistura said. He added: \"There are still major differences on the major issues, but there is movement on certain areas where there was not before.\"  Mr de Mistura also said that equal rights and equal representation in major institutions for women was essential to the transition to a new Syria. The peace talks do not involve the al-Qaeda-linked al-Nusra front and the so-called Islamic State, which have been fighting government forces and other rebels across Syria. More than 270,000 people have been killed since Syria's bitter civil war conflict erupted in 2011 and millions have been forced to flee."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
## [2] "The UN says the situation in Syria's city of Aleppo is catastrophic, after dozens of people were killed in attacks on targets including a hospital  Air strikes on and around the Medecins Sans Frontieres-backed al-Quds hospital killed at least 27 people, while more than 30 died in other attacks. UN envoy Jan Egeland said the next days would be vital for the humanitarian aid lifeline for much of Syria. The violence has left a partial truce hanging by a thread. UN envoy for Syria Staffan de Mistura warned the cessation of hostilities agreed between non-jihadist rebels and government forces on 27 February was now \"barely alive\". Separately, the Syrian government reported that 150 US troops had arrived in the town of Rmeilan in Syria's predominantly northern Kurdish province of Hassakeh, denouncing it as an \"illegitimate intervention\". US President Barack Obama said last week he was deploying 250 troops to Syria to help certain rebel groups fight so-called Islamic State (IS). Mr Egeland, the head of the UN humanitarian assistance to Syria, said he had been briefed on \"the catastrophic deterioration in Aleppo over the last 24-48 hours... No-one doubts the severity of the situation.\" He warned that the humanitarian lifeline for much of the country was at risk. \"I could not in any way express how high the stakes are for the next hours and days. \"So many humanitarian health workers and relief workers are being bombed, killed, maimed at the moment that the whole lifeline to millions of people is now also at stake.\" Medecins Sans Frontieres (MSF) said at least 14 patients and three doctors had been killed in the air strike on al-Quds hospital. Among those killed was Mohammed Wasim Moaz, one of the city's last paediatricians, MSF said. An MSF representative, Aitor Zabalgogeazkoa, told the BBC Dr Moaz had worked at the hospital since 2013. Mr Zabalgogeazkoa said: \"He kept it going, was always there and always worried about the needs of the people. He was honest and very committed. He worked in conditions you cannot even begin to imagine.\" Local sources blamed war planes from the Syrian military or from Russia, which is supporting the government of President Bashar al-Assad, for the attack. The Syrian military denied targeting the hospital. A military source was quoted on state TV as saying: \"Such news is merely an attempt to cover up terrorist crimes which target peaceful citizens in Aleppo.\" An activist at the scene, named Zuhair, told the BBC: \"It was an air strike by two rockets, heavy rockets from [a] Russian air strike. \"Near the hospital, one building on five floors just crumbled and just crashed down and we don't know how many dead will be under these ruins.\" However, Russian news agencies quoted the Russian defence ministry as saying it had carried out no air strikes in Aleppo in the past few days. US Secretary of State John Kerry said he was \"outraged\" by the hospital attack, adding: \"It appears to have been a deliberate strike on a known medical facility and follows the Assad regime's appalling record of striking such facilities.\" UN Secretary General Ban Ki-moon called on both the US and Russia to exert pressure to stop the violence, and demanded a credible investigation into the hospital attack. Monitoring groups said at least 20 people were killed in other attacks on rebel-held areas in Aleppo on Thursday, while at least 14 died in rocket strikes on government-controlled neighbourhoods. The upsurge in violence comes amid reports that the Syrian army, backed by Russian air power, is gearing up for a major offensive in Aleppo. One of the reasons why the \"cessation of hostilities\" is now at death's door was reflected in the fact that from the outset it was not called a ceasefire or even a truce, because several factions were excluded, including not just the Islamic State militants but also the al-Qaeda-linked Nusra Front.  Nusra fighters are present in almost all combat zones, and are mixed up with other groups such as Ahrar al-Sham that Russia is now pressing to have added to the international terror list.  That has meant that hostilities have continued and intensified in many areas, with the government able to claim its attacks are legitimate.  Now state forces are reported to be building up in Aleppo as violence escalates there, raising fears that a long and costly all-out battle for the contested city may be looming.  That would put paid both to the lull and to the Geneva peace talks, prompting Mr de Mistura to urge the US, Russians and others to press their clients on the ground to ease off, so that stalled negotiations have a chance of resuming. "
## [3] "A 23-year-old Iranian asylum seeker who set himself on fire at Australia's detention centre on the island of Nauru has died.  Australia's immigration department confirmed the man died at Brisbane Hospital on Friday. His actions were a \"political protest\", according to the Nauruan government. Australia sends asylum seekers it intercepts for processing at offshore locations, including Nauru, a small Pacific Island nation.  The man, known as Omid, set himself on fire at the Nauru detention centre on Tuesday and was airlifted to Brisbane Hospital in Australia with severe burns to his torso. A statement from the Department of Immigration and Border Protection said it was providing \"appropriate support\" to the man's wife and friends.  Graphic video footage of the incident, which reportedly occurred during a United Nations visit to the island, has been published on Australian news websites. This man's death comes as Australia's other offshore processing centre on Manus Island in Papua New Guinea, is threatened with closure. Papua New Guinea's Supreme Court ruled the detention of asylum seekers was unconstitutional and therefore illegal on Tuesday. The fate of around 850 asylum seekers and refugees on Manus Island - all men - remains uncertain, with Australian and Papua New Guinean officials set to hold talks early next week.  After the Supreme Court's decision, Papuan New Guinea Prime Minister Peter O'Neill told Australia it must close the Manus Island centre and make new arrangements. But Australian Prime Minister Malcolm Turnbull has repeatedly said that none of the men on Manus Island will come to Australia.  Mr Turnbull also ruled out sending them to New Zealand, which has previously offered to take some of the refugees Australia refuses to settle, as this would provide a \"marketing opportunity\" for people smugglers.  \"We have to be very, very clear eyed about this. We can't afford to let the empathy that we feel for the desperate circumstances that many people find themselves in to cloud our judgment,\" Mr Turnbull said.  \"Our national security has to come first.\" Meanwhile five MPs from the opposition Labor party have broken ranks and declared they do not support Australia's offshore processing regime.  The tough immigration policy has bipartisan support from Labor and the ruling coalition.  Labor MP Melissa Parke, a former lawyer with the United Nations, said the policy was \"a sick game that needs to end\". \"It's inevitable that the government will need to have another plan for what is going to happen, and the most logical thing to do is to bring those people to Australia,\" Ms Parke told Fairfax Media."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
## [4] "Brazilian prosecutors have filed corruption charges against President Dilma Rousseff's electoral strategist.  Joao Santana was widely seen as the architect of Ms Rousseff's 2010 and 2014 election victories.   He has denied receiving bribes in a scheme to divert funds from the state-run oil company Petrobras.   About 50 Brazilian politicians, including the leader of the lower house of Congress, are under investigation in the Petrobras corruption scandal.  Mr Santana is accused of receiving bribes from several large engineering conglomerates.  Analysts say the charge against him is a further blow for President Rousseff who is facing impeachment proceedings.  He was arrested in February after he returned from the Dominican Republic, where he was working on the re-election campaign of President Danilo Medina. Because of his proximity to her, the arrest is expected to damaged her standing further, even though impeachment proceedings against her are not related to the Petrobras corruption investigation.  A former journalist, Mr Santana is well known for producing dramatic, big-budget campaign videos appealing to poorer voters.  Mr Santana had called the accusations \"unfounded\".  And he had harsh words for the investigation, saying that Brazil was currently living in a \"climate of persecution\". If the investigating judge accepts the allegations against him, Mr Santana will be jailed.  In Brasilia, a special Senate commission has begun hearings ahead of a vote on whether the whole Senate should take on impeachment proceedings against President Rousseff.  A plenary Senate vote is widely expected to take place around 11 May. Across the country,  pro-government supporters blocked major roads in cities in nine Brazilian states during Thursday's morning rush-hour to call for the halt of impeachment proceedings against President Rousseff.   In Sao Paulo, the city saw hundreds of kilometres of traffic jams which formed behind roadblocks of burning tyres. "
```

---

class: break

# Legality

Now that you've learned how to build a simple scaper. Here are a few things to keep in mind…

![:space 5]

**Don't scrape too fast!&lt;/font&gt;**

- Your behavior is statistically distinguishable from human users.

- Constitutes a [DDOS attack](https://en.wikipedia.org/wiki/Denial-of-service_attack)

- Known the websites **terms of service** – breaking those terms can lead to being banned from the site or even [jail time](https://www.wired.com/2011/07/swartz-arrest/).


---

# Solution

&lt;br&gt;

- **Slow down**

- **Add noise** to make your behavior less statistically distinguishable.

- **Know what you're doing** and who you're doing it to.
  + In the words of Nietzsche: “if thou gaze long into an abyss, the abyss will also gaze into thee”
  + That is, the internet is a two way street. Scraping content from some sites puts you on peoples' radar.

- [`robot.txt`](http://www.robotstxt.org/) to know what you can and can't scrape.
  + `www.bbc.com/robots.txt`

---

# Solution

&lt;br&gt;

Create noise by **randomly** putting your scraper to **sleep**.


```r
# One random unit of time drawn from a uniform distribution
runif(1,1,4) 
```

```
## [1] 1.76333
```
&lt;br&gt;
&lt;br&gt;

```r
# Put the system to sleep by that random unit
Sys.sleep(runif(1,1,5))
```

---

# Solution

&lt;br&gt;

Using our previous example, we deliberately slow `bbc_scraper()` down:



```r
output &lt;- c()
for(i in 1:length(urls)){
* Sys.sleep(runif(1,1,5))
  draw &lt;- bbc_scraper(urls[i])  
  output &lt;- bind_rows(output,draw)
}
```

&lt;br&gt;

Keep in mind that if you're a social scientist (which we are), nothing you're doing is **_that_** pressing. You can wait and everyone will be better off for it!

---

## Grab data once, &lt;br&gt; _not again and again_....

One important thing to keep in mind when writing scraping code in `.Rmd`: we _don't_ want to accidently _re-scrape_ the data every time we knit the document! 

**Two stategies to get around this:**

- **_(1) cache results for code chunks that aim to scrape data._**

- **_(2) set `eval = FALSE` for the code chunks that aim to scrape data._**

    - Scrape the data on your own;
    - Save the data to the project;
    - Re-read the data back in when knitting the document.

---

class: newsection

# APIs

---

### Application Programming Interface (API)

- APIs take user requests to a system and return a response (usually in the form of data)
  + Classic example: think waiter at a restraunt, you give him/her your order, waiter goes to the kitchen, waiter brings back what you ordered.
  
- an API is the way applications speak to databases. 
  + For example, when a news interface presents statistics regarding how often someone "liked" a story on social media, they are using an API to request from the social media's database how many time the story has been shared, the social media site's API then returns a number (likes/shares/retweets/etc.) which the news website then reports

- We use APIs all the time: online forms, aggregation sites, apps, ect. 

---

### Application Programming Interface (API)

- There are many kinds of APIs, but we'll focus on **REST APIs** 
  
  + REST == "**re**presntational **s**tate **t**ransfer"
  
  + Works like a website: client makes a request to a server via the http protocol. 
  
  + Looks and behaves much like a url
  
  + Returns data formated as Java Script Object Notation (JSON) data: structured as key value pairs. 
  
  + `httr` packages converts json to lists in `R`
  
- Most all APIs require and **API key** or token to access.
  
---

### Example: Data.gov

- Data.gov [documentation](https://api.data.gov/) for their various APIs

- Need API Key: [get a key](https://api.data.gov/signup/)


```r
require(httr) # To make requests
api &lt;- 'https://catalog.data.gov/api/3/action/group_list'
get_cat &lt;- GET(api)
content(get_cat)
```

```
## $help
## [1] "https://catalog.data.gov/api/3/action/help_show?name=group_list"
## 
## $success
## [1] TRUE
## 
## $result
## $result[[1]]
## [1] "aapi0916"
## 
## $result[[2]]
## [1] "aging"
## 
## $result[[3]]
## [1] "agriculture8571"
## 
## $result[[4]]
## [1] "businessusa4208"
## 
## $result[[5]]
## [1] "climate5434"
## 
## $result[[6]]
## [1] "consumer9350"
## 
## $result[[7]]
## [1] "disasters"
## 
## $result[[8]]
## [1] "ecosystems0617"
## 
## $result[[9]]
## [1] "education2168"
## 
## $result[[10]]
## [1] "energy9485"
## 
## $result[[11]]
## [1] "finance3432"
## 
## $result[[12]]
## [1] "law1129"
## 
## $result[[13]]
## [1] "local"
## 
## $result[[14]]
## [1] "manufacturing7382"
## 
## $result[[15]]
## [1] "maritime"
## 
## $result[[16]]
## [1] "ocean9585"
## 
## $result[[17]]
## [1] "opportunity-030717"
## 
## $result[[18]]
## [1] "research9385"
## 
## $result[[19]]
## [1] "safety3175"
## 
## $result[[20]]
## [1] "states6394"
## 
## $result[[21]]
## [1] "wwhgd"
```

---

### Example: Department of Education



Make request

```r
api &lt;- 'https://api.data.gov/ed/collegescorecard/v1/schools'
data_request &lt;- GET(api,
*                   query=list(api_key=my_api_key, # Need your key
                               school.name="Georgetown University"))
```


```r
# Extract content
dat &lt;- content(data_request)
names(dat) # what is returned is a huge list!
```

```
## [1] "metadata" "results"
```

Large list that we can handle into...

```r
# Number of Graduate students enrolled in 2016
dat$results[[1]]$`2016`$student$grad_students
```

```
## [1] 11072
```

---

### Example: FBI API

[Crime Data Explorer](https://crime-data-explorer.fr.cloud.gov/api)

API Set up: `/api/nibrs/{offense}/victim/national/{variable}`

Make call to the API

```r
fbi_api &lt;- 'https://api.usa.gov/crime/fbi/sapi/api/nibrs/homicide/victim/national/age'
get_fbi_dat &lt;- GET(fbi_api,query=list(api_key=my_api_key))
fbi_dat &lt;- content(get_fbi_dat)

# Tap into the results...
as_tibble(fbi_dat$data[[1]])
```

```
## # A tibble: 1 x 4
##   value data_year month_num key  
##   &lt;int&gt;     &lt;int&gt;     &lt;int&gt; &lt;chr&gt;
## 1   181      2008         0 0-9
```

---

Need to reorganize into a single data frame.We can build this data up by using a loop!

```r
total_entries &lt;- length(fbi_dat$data) 
total_entries
```

```
## [1] 308
```


```r
homicide_data &lt;- c()
for(i in 1:total_entries){
* tmp &lt;- as_tibble(fbi_dat$data[[i]])
  homicide_data &lt;- bind_rows(homicide_data,tmp)
}
homicide_data
```

```
## # A tibble: 308 x 4
##    value data_year month_num key  
##    &lt;int&gt;     &lt;int&gt;     &lt;int&gt; &lt;chr&gt;
##  1   181      2008         0 0-9  
##  2   194      2011         0 0-9  
##  3   112      2003         0 0-9  
##  4   159      2006         0 0-9  
##  5   168      2009         0 0-9  
##  6   204      2016         0 0-9  
##  7    30      1994         0 0-9  
##  8   102      2002         0 0-9  
##  9    36      1997         0 0-9  
## 10   159      2005         0 0-9  
## # … with 298 more rows
```

---

Now manipulate...


```r
homicide_data_clean &lt;-
  homicide_data %&gt;%  
  select(year = data_year,
         age_range = key,
         count = value) %&gt;%  
  arrange(year,age_range) # Arrange by year, age

# Print
homicide_data_clean
```

```
## # A tibble: 308 x 3
##     year age_range count
##    &lt;int&gt; &lt;chr&gt;     &lt;int&gt;
##  1  1991 0-9          24
##  2  1991 10-19       105
##  3  1991 20-29       253
##  4  1991 30-39       202
##  5  1991 40-49       102
##  6  1991 50-59        38
##  7  1991 60-69        38
##  8  1991 70-79        16
##  9  1991 80-89        11
## 10  1991 90-Older      1
## # … with 298 more rows
```

---

Finally, let's visualize!


```r
homicide_data_clean %&gt;% 
  ggplot(aes(year,age_range,fill=log(count))) +
  geom_tile() +
  scale_fill_viridis_c() +
  theme_minimal() +
  labs(y="Age Range",x="Year",
       title="Total Number of Deaths by Homicide by Age in the U.S. (1995 to 2018)",
       subtitle="Data drawn from FBI database ",
       caption = "Source: Data.Gov")
```

&lt;img src="lecture-week-06_webscraping-and-apis_files/figure-html/unnamed-chunk-36-1.png" style="display: block; margin: auto;" /&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"countIncrementalSlides": false,
"highlightLines": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
