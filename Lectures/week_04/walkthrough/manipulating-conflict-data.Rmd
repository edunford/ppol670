---
title: |
 | Enhance and Advance
 | Introduction to R
subtitle: "Manipulating Conflict Event Data" 
author: Eric Dunford
affiliation: "Georgetown University"
date: "Summer 2020" 
output: 
  html_notebook:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r,include = F}
knitr::opts_chunk$set(error=F,warning = F)
```

# Overview

In this notebook, we'll hone our data manipulation skills by examining conflict event data generated by the [Armed Conflict Location & Event Data Project (ACLED)](https://acleddata.com/#/dashboard). The aim is to practice some of the tidyverse functions covered in the lecture. 

As always, we need to make sure we have the `tidyverse` packages installed and loaded. 

```{r}
# install.packages("tidyverse")  
require(tidyverse) 
```


# Data 

ACLED is a "disaggregated data collection, analysis, and crisis mapping project. ACLED collects the dates, actors, locations, fatalities, and modalities of all reported political violence and protest events across Africa, South Asia, Southeast Asia, the Middle East, Central Asia and the Caucasus, Latin America and the Caribbean, and Southeastern and Eastern Europe and the Balkans." For this exercise, we'll focus just on the data pertaining to _Africa_. For more information regarding these data, please consult the [ACLED methodology](https://acleddata.com/resources/methodology/).

```{r}
acled <- read_csv("https://raw.githubusercontent.com/edunford/enhance_and_advance_R/master/lectures/wrangling/walkthroughs/acled_africa.csv")
head(acled)
```


# Know your data

To understand a dataset, one needs to ask a lot of questions of it. To get a better feel for the ACLED data, let's explore the following questions:

#### 1. What's the temporal coverage of the data?

```{r}
acled %>% 
  group_by(country) %>% 
  summarize(min_year = min(year),
            max_year = max(year))
```


#### 2. How many events are recorded for each country? 

```{r}
acled %>% 
  count(country,sort=T)
```

#### 3. How many events are recorded for each year?

```{r}
acled %>% 
  count(year,sort=T)
```


#### 4. What's the most common event type in the data?

```{r}
acled %>% 
  group_by(event_type) %>% 
  summarize(n_events = n()) %>% 
  arrange(desc(n_events))
```


#### 5. How many `sub_` event types are there for each event type?

```{r}
acled %>% 
  group_by(event_type) %>% 
  summarize(n_subtypes = n_distinct(sub_event_type)) %>% 
  arrange(desc(n_subtypes))
```


#### 6. Which countries had the highest number of reported fatalities? 

```{r}
new_data <- 
  acled %>% 
  group_by(country,year) %>% 
  summarize(fatalities = sum(fatalities)) %>% 
  arrange(desc(fatalities))

new_data
```


# Political Violence &rarr; Economic Growth

Let's say we wanted to estimate the impact of political violence on economic growth. Specifically, we want to known how the number of fatalities as a result of political instability impacts the economic growth of a country. Construct a data set that would allow you to answer this question and use OLS to estimate the relationship model.


## Data on Economic Growth

First, I've provided data from the `World Bank` that captures the economic growth rate by country-year.

```{r}
# install.packages(wbstats) # API for downloading WB data
require(wbstats)

# Download the data
gdppp_growth <- wb(country = "countries_only",indicator = "NY.GDP.PCAP.KD.ZG") %>% 
  mutate(date=as.numeric(date))

# Look at the top of the data
head(gdppp_growth)
```

## Transform the event data

The unit of analysis of the acled data is set at the location-day. We need to aggregate these data so that it is at the country-year. Relying only on the tidyverse function, generate a new data frame that has the following fields:

- `country` (unit);
- `year` (time);
- `fatalities` = total number of fatalities in a given country-year;
- `ln_fatalities` = natural log of the number of fatalities (main IV);
- `n_events` = total number of events that took place in a given country;
- `ln_n_events` = natural log of the number of events (control).

 

```{r}
acled_country_year <-
  acled %>% 
  group_by(country,year) %>% 
  summarize(fatalities = sum(fatalities),
            ln_fatalities = log(fatalities + 1),
            n_events = n(),
            ln_n_events = log(n_events + 1)) %>% 
  ungroup

acled_country_year %>% sample_n(5)
```

## Join the Data

Now that we've converted our event-level data into coutry-year-level data, let's merge the growth data onto the conflict data.

A few things to keep in mind:

- Country names might be spelled differently, so we'll want to double check that no data was lost in the merge. 
- There are more countries in the wb data than the acled data, so we'll want to make sure we merge _onto_ the acled data and not the other way around. 

```{r}
# Reduce the acled data down.
gdppp_growth2 <- gdppp_growth %>% select(country, year = date, growth = value)

# join
dat <- left_join(acled_country_year,gdppp_growth2,by=c("country","year"))

# look at the data 
dat %>% sample_n(5)
```
Are we missing any countries? That is, did we any countries not come through when merging?

```{r}
dat %>% 
  group_by(country) %>% 
  summarize(n_missing = sum(is.na(growth)),
            total = n(),
            prop_missing = n_missing/total) %>% 
  arrange(desc(n_missing))
```

Oh no -- loooks like we missed a few. Let's explore why. As we can see below, it looks like the WB has different naming conventions for some of the countries. 

```{r}
gdppp_growth2 %>% 
  filter(str_detect(country,"Congo")) %>% 
  distinct(country)
```

Note a problem! Let's standardize the naming conventions using the `countrycode` package.

```{r}
# install.packages(countrycode)
require(countrycode)

# Standardize the country names for the WB data
gdppp_growth3 <- 
  gdppp_growth2 %>% 
  mutate(country = countrycode(country,"country.name","country.name"))

# Standardize the country names for the ACLED data
acled_country_year2 <- 
  acled_country_year %>% 
  mutate(country = countrycode(country,"country.name","country.name"))
  

# join
dat <- left_join(acled_country_year2,gdppp_growth3,by=c("country","year"))

# look at the data 
dat %>% sample_n(5)
```

Check again if there are any issues? 

```{r}
dat %>% 
  group_by(country) %>% 
  summarize(n_missing = sum(is.na(growth)),
            total = n(),
            prop_missing = n_missing/total) %>% 
  arrange(desc(n_missing))
```


Still missing data for Somalia. Why is this? Doesn't look like the WB has growth data for Somalia after 1990. 

```{r}
gdppp_growth3 %>% 
  filter(country == "Somalia") %>% 
  summary()
```

## Run model

Let's now run our (very basic) analysis!

```{r}
dat %>% 
  lm(growth ~ ln_fatalities, data = .) %>% 
  summary(.)
```
Now controlling for the number of event in the country.

```{r}
dat %>% 
  lm(growth ~ ln_fatalities + ln_n_events, data = .) %>% 
  summary(.)
```
